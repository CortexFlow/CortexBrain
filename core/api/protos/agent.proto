syntax = "proto3";
package agent;

import "google/protobuf/empty.proto";

// Active connections

message RequestActiveConnections{
    optional string pod_ip = 2 ;
}

message ConnectionEvent {
    string event_id = 1;
    string src_ip_port = 2;  // e.g., "192.168.1.1:8080" (src_ip:src_port)
    string dst_ip_port = 3;  // e.g., "10.0.0.1:80" (dst_ip:dst_port)
}

message ActiveConnectionResponse{
    string status = 1;
    repeated ConnectionEvent events = 2;  // List of connection events
}

// Network metrics



// Latency metrics request and response messages

message LatencyMetricsRequest {
    optional uint32 tgid = 1;         // Filter by thread group ID
    optional string process_name = 2; // Filter by process name
    optional uint64 start_time = 3;   // Start timestamp (microseconds)
    optional uint64 end_time = 4;     // End timestamp (microseconds)
}

message LatencyMetric {
    uint64 delta_us = 1;          // Latency in microseconds
    uint64 timestamp_us = 2;      // Event timestamp
    uint32 tgid = 3;              // Thread group ID
    string process_name = 4;      // Process name (comm)
    uint32 local_port = 5;        // Local port
    uint32 remote_port = 6;       // Remote port (big-endian)
    uint32 address_family = 7;    // "IPv4" or "IPv6"
    string src_address_v4 = 8;       // Source IP address
    string dst_address_v4 = 9;       // Destination IP address
    string src_address_v6 = 10;      // Source IPv6 address
    string dst_address_v6 = 11;      // Destination IPv6 address
}

message LatencyMetricsResponse {
    string status = 1;
    repeated LatencyMetric metrics = 2;
    uint32 total_count = 3;
    double average_latency_us = 4;    // Average latency
    double min_latency_us = 5;        // Minimum latency
    double max_latency_us = 6;        // Maximum latency
}

// Packet Loss Metrics

message PacketLossMetricsRequest {
    optional uint32 tgid = 1;         // Filter by thread group ID
    optional uint64 start_time = 2;   // Start timestamp
    optional uint64 end_time = 3;     // End timestamp
}

message PacketLossMetric {
    uint32 tgid = 1;                          // Thread group ID
    string process_name = 2;                  // Process name
    uint64 timestamp_us = 3;                  // Event timestamp
    uint32 total_packets_lost = 4;            // Total packets lost
    uint32 total_packets_transmitted = 5;     // Total packets transmitted
    double packet_loss_percentage = 6;        // % of total packet loss
    uint64 total_data_loss_bytes = 7;         // Total size of data loss
    uint64 total_data_transmitted_bytes = 8;  // Total transmitted data
    double data_loss_ratio = 9;               // Ratio between loss and transmitted
}

message PacketLossMetricsResponse {
    string status = 1;
    repeated PacketLossMetric metrics = 2;
    uint32 total_connections = 3;
}

// Dropped TCP Packets

message DroppedPacketsRequest {
    optional uint32 tgid = 1;         // Filter by thread group ID
    optional uint64 start_time = 2;   // Start timestamp
    optional uint64 end_time = 3;     // End timestamp
}

message DroppedPacketMetric {
    uint32 tgid = 1;                  // Thread group ID
    string process_name = 2;          // Process name
    int32 sk_drops = 3;               // Socket drops (from sk_drops field)
    int32 sk_err = 4;                 // Socket errors
    int32 sk_err_soft = 5;            // Soft errors
    uint32 sk_backlog_len = 6;        // Backlog length (congestion indicator)
    int32 sk_wmem_queued = 7;         // Write memory queued
    int32 sk_rcvbuf = 8;              // Receive buffer size
    uint32 sk_ack_backlog = 9;        // ACK backlog
    uint64 timestamp_us = 10;         // Event timestamp
}

message DroppedPacketsResponse {
    string status = 1;
    repeated DroppedPacketMetric metrics = 2;
    uint32 total_drops = 3;           // Total drops across all connections
}


//declare agent api 
service Agent{
    
    // active connections endpoint 
    rpc ActiveConnections(RequestActiveConnections) returns (ActiveConnectionResponse);
    
    // create blocklist endpoint
    rpc AddIpToBlocklist(AddIpToBlocklistRequest) returns (BlocklistResponse);
    rpc CheckBlocklist(google.protobuf.Empty) returns (BlocklistResponse);

    // remove ip from blocklist endpoint
    rpc RmIpFromBlocklist(RmIpFromBlocklistRequest) returns (RmIpFromBlocklistResponse);

    // metrics data
    rpc GetLatencyMetrics(LatencyMetricsRequest) returns (LatencyMetricsResponse);

    rpc GetPacketLossMetrics(PacketLossMetricsRequest) returns (PacketLossMetricsResponse);

    rpc GetDroppedPacketsMetrics(DroppedPacketsRequest) returns (DroppedPacketsResponse);
}

message AddIpToBlocklistRequest{
    optional string ip = 1 ;
}

message BlocklistResponse{
    string status = 1 ;
    map<string,string> events = 2 ;
}
message RmIpFromBlocklistRequest{
    string ip = 1 ;
}
message RmIpFromBlocklistResponse{
    string status = 1;
    map<string,string> events = 2 ;
}
